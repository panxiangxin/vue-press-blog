# 从用户输入网址到页面渲染的过程

## 1、判断输入

浏览器判断用户输入是否是合法的`URL`地址还是关键字，关键字的话调用默认的搜索引擎进行搜索。如果是`URL`资源地址，则调用网络进程进行处理。

## 2、DNS 域名解析

`DNS`域名解析流程主要是寻找域名对应的IP地址。浏览器缓存 -> 本机缓存 -> 硬盘host缓存 -> 路由器缓存 -> 网络运营商域名服务器 -...-> 根域名服务器

## 3、建立TCP连接

网络进程判断是否本地有该资源缓存，判断资源是否过期，没有过期直接将本地资源返回。不然开始构建TCP连接。

获取到对应的服务器IP之后，根据URL确定端口，默认是80端口。客户端、服务端进行三次握手建立`TCP`连接。这里涉及到`OSI`七层网络模型，不过现在一般使用的是`TCP/IP`五层模型。

`OSI（Open System Interconnection Reference）`七层网络模型

- 1. 应用层
- 2. 表示层
- 3. 会话层
- 4. 传输层
- 5. 网络层
- 6. 数据链路层
- 7. 硬件层

`TCP` 属于传输层协议 `HTTP` 属于应用层协议。

`TCP/IP` 五层协议模型 将`应用层`、`表示层`、`会话层`合并。

## 4、发送HTTP请求

网络进程开始构建`HTTP`请求，`HTTP`请求包括以下几个部分。

- 1. 请求行 请求方法、请求URI HTTP版本协议
- 2. 请求头 浏览器的一些基本信息 操作系统、浏览器内核、当前请求域名信息、Cookie 等等
- 3. 请求体 具体数据 比如POST 请求 就把传输数据放在这一块

![](https://static001.geekbang.org/resource/image/b8/d7/b8993c73f7b60feb9b8bd147545c47d7.png)

## 5、服务器返回请求

服务器 接收请求处理之后，会返回数据给浏览器，返回请求结构为：

- 1. 响应行 HTTP版本协议 状态码 
- 2. 响应头 
- 3. 响应体

![](https://static001.geekbang.org/resource/image/3e/76/3e30476a4bbda49fd7cd4fd0ea09f076.png)

首先服务器会返回响应行，包括协议版本和状态码。

但并不是所有的请求都可以被服务器处理的，那么一些无法处理或者处理出错的信息，怎么办呢？服务器会通过请求行的状态码来告诉浏览器它的处理结果，比如：

`1xx`字段表示已接收数据

最常用的状态码是`200`，表示处理成功；

如果没有找到页面，则会返回`404`；

页面重定向的话、返回`301` 并且跳转的网址放在location里面。

状态码类型很多，这里我就不过多介绍了。

随后，正如浏览器会随同请求发送请求头一样，服务器也会随同响应向浏览器发送响应头。响应头包含了服务器自身的一些信息，比如服务器生成返回数据的时间、返回的数据类型（JSON、HTML、流媒体等类型），以及服务器要在客户端保存的`Cookie`等信息。

发送完响应头后，服务器就可以继续发送响应体的数据，通常，响应体就包含了`HTML`的实际内容。

判断响应头的content-type字段的值是否是text/html，是的话这就告诉浏览器，服务器返回数据是HTML格式。如果是application/octet-stream表示数据是字节流，通常情况下浏览器会按照下载类型来请求。

所以不同Content-type类型，浏览器处理方式也不同。

## 6、准备渲染阶段

默认情况下浏览器会为每一个页面分配一个渲染进程，也就是说每新开一个页面就会创建一个渲染进程。但也有一些例外、浏览器会让多个页面用同一个渲染进程。

打开一个新页面采用的渲染进程策略就是：

- 通常情况下，打开新的页面都会使用单独的渲染进程；
- 如果从A页面打开B页面，且A和B都属于同一站点的话，那么B页面复用A页面的渲染进程；如果是其他情况，浏览器进程则会为B创建一个新的渲染进程。

渲染进程准备好之后，还不能立即进入文档解析状态，因为此时的文档数据还在网络进程中，并没有提交给渲染进程，所以下一步就进入了提交文档阶段

## 7. 提交文档

首先明确的是，这里的“文档”指的是URL请求的响应体数据。

- “提交文档”是浏览器进程发出的，渲染进程接收到“提交文档”信息，会和网络进程建立连接传输数据。
- 等文档传输完毕后，渲染进程发送“确认提交”信息给浏览器进程。
- 浏览器进程接收到“确认提交”信息，会更新浏览器状态、包括了 安全状态、地址栏的URL、前进后退的状态、并且更新页面。

![](https://static001.geekbang.org/resource/image/a1/6f/a1b77a61361561e74e86fdae10ee246f.png)

这也就解释了为什么在浏览器的地址栏里面输入了一个地址后，之前的页面没有立马消失，而是要加载一会儿才会更新页面。

到这里，一个完整的导航流程就“走”完了，这之后就要进入渲染阶段了。

## 8. 渲染阶段

一旦文档被提交，渲染进程便开始页面解析和子资源加载。---待更新